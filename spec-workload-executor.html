
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Workload Executor Specification &#8212; astrolabe  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Atlas Planned Maintenance Test Scenario Format" href="spec-test-format.html" />
    <link rel="prev" title="Integration Guide" href="integration-guide.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="workload-executor-specification">
<span id="id1"></span><h1>Workload Executor Specification<a class="headerlink" href="#workload-executor-specification" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Detailed information about terms that are italicized in this document can be found in the
<a class="reference internal" href="technical-design.html#terms-technical-design"><span class="std std-ref">Terms</span></a> section.</p>
</div>
<p>The <em>Workload Executor</em> is a script that translates a <em>Driver Workload</em> specified in a <em>Test Scenario File</em> into
driver operations that are run against a test cluster. This script MUST be implemented by every driver.
Workload Executors enable the reuse of <code class="docutils literal notranslate"><span class="pre">astrolabe</span></code>’s test orchestration and cluster monitoring capabilities across
all drivers by providing an abstraction for translating <em>Driver Workloads</em> specified in the platform-agnostic
test format into native driver operations that are run against a live Atlas cluster.</p>
<section id="user-facing-api">
<h2>User-Facing API<a class="headerlink" href="#user-facing-api" title="Permalink to this headline">¶</a></h2>
<p>The Workload Executor MUST be a standalone executable that can be invoked as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ path/to/workload-executor connection-string workload-spec
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">path/to/workload-executor</span></code> is the path to the Workload Executor executable script,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">connection-string</span></code> is <code class="docutils literal notranslate"><span class="pre">mongodb+srv</span></code> which may contain any of the
<a class="reference external" href="https://github.com/mongodb/specifications/blob/master/source/uri-options/uri-options.rst">standardized URI options</a>
that is to be used to connect to the Atlas cluster, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">workload-spec</span></code> is a JSON blob representation of the <code class="docutils literal notranslate"><span class="pre">driverWorkload</span></code> field from the
<a class="reference internal" href="spec-test-format.html#test-scenario-format-specification"><span class="std std-ref">Atlas Planned Maintenance Test Scenario Format</span></a>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some languages might find it convenient to wrap their natively implemented workload executors in a shell
script in order to conform to the user-facing API described here. See <a class="reference internal" href="integration-guide.html#wrapping-workload-executor-shell-script"><span class="std std-ref">Wrapping native workload executors with a shell script</span></a>
for details.</p>
</div>
</section>
<section id="behavioral-description">
<h2>Behavioral Description<a class="headerlink" href="#behavioral-description" title="Permalink to this headline">¶</a></h2>
<p>After accepting the inputs, the workload executor:</p>
<ol class="arabic">
<li><p>MUST use the input connection string to <a class="reference external" href="https://github.com/mongodb/specifications/blob/master/source/unified-test-format/unified-test-format.rst#id92">instantiate the
unified test runner</a>
of the driver being tested. Note that the workload executor:</p>
<ul class="simple">
<li><p>MUST NOT override any of the URI options specified in the incoming connection string.</p></li>
<li><p>MUST NOT augment the incoming connection string with any additional URI options.</p></li>
</ul>
</li>
<li><dl class="simple">
<dt>MUST parse the incoming <code class="docutils literal notranslate"><span class="pre">driverWorkload</span></code> document and set up</dt><dd><p>the driver’s unified test runner to execute the provided workload.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The workload SHOULD include a <code class="docutils literal notranslate"><span class="pre">loop</span></code> operation, as described in the
unified test format, but the workload executor SHOULD NOT validate that
this is the case.</p>
</div>
</li>
<li><p>MUST set a signal handler for handling the termination signal that is
sent by <code class="docutils literal notranslate"><span class="pre">astrolabe</span></code>. The termination signal is used by <code class="docutils literal notranslate"><span class="pre">astrolabe</span></code>
to communicate to the workload executor, and ultimately the unified test
runner, that they should stop running operations.</p></li>
<li><p>MUST initialize the following variables, which will later be used to generate
the <code class="docutils literal notranslate"><span class="pre">results.json</span></code> and <code class="docutils literal notranslate"><span class="pre">events.json</span></code> output files:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">events</span></code>: Empty array of objects.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">errors</span></code>: Empty array of objects.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">failures</span></code>: Empty array of objects.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numIterations</span></code>: Integer with value -1.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numSuccesses</span></code>: Integer with value -1.</p></li>
</ul>
<p>Note: <code class="docutils literal notranslate"><span class="pre">numErrors</span></code> and <code class="docutils literal notranslate"><span class="pre">numFailures</span></code> are intentionally omitted here as
they will be derived directly from <code class="docutils literal notranslate"><span class="pre">errors</span></code> and <code class="docutils literal notranslate"><span class="pre">failures</span></code>.</p>
</li>
<li><p>MUST invoke the unified test runner to execute the workload.
If the workload includes a <code class="docutils literal notranslate"><span class="pre">loop</span></code> operation, the workload will run until
terminated by the workload executor; otherwise, the workload will terminate
when the unified test runner finishes executing all of the operations.
The workload executor MUST handle the case of a non-looping workload and
it MUST terminate if the unified test runner completely executes the
specified workload.</p>
<p>If the unified test runner raises an error while executing the workload,
the error MUST be reported using the same format as errors handled by the
unified test runner, as described in the unified test runner specification
under the <code class="docutils literal notranslate"><span class="pre">loop</span></code> operation. The error MUST be appended to the <code class="docutils literal notranslate"><span class="pre">errors</span></code>
array.</p>
<p>If the unified test runner reports a failure while executing the workload,
the failure MUST be reported using the same format as failures handled by the
unified test runner, as described in the unified test runner specification
under the <code class="docutils literal notranslate"><span class="pre">loop</span></code> operation. The failure MUST be appended to either the
<code class="docutils literal notranslate"><span class="pre">failures</span></code> array or, if the workload executor cannot distinguish between
errors and failures, the <code class="docutils literal notranslate"><span class="pre">errors</span></code> array.</p>
</li>
<li><p>Upon receipt of the termination signal, MUST instruct the
unified test runner to stop looping, as defined in the unified test format.</p></li>
<li><p>MUST wait for the unified test runner to finish executing.</p></li>
<li><p>MUST use the unified test runner to retrieve the following
entities by name from the entity map, if they are set:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">iterations</span></code>: The number of iterations that the workload executor
performed over the looped operations. If set, this value MUST be assigned
to the workload executor’s <code class="docutils literal notranslate"><span class="pre">numIterations</span></code> variable. Note that this
entity may be unset if the workload’s <code class="docutils literal notranslate"><span class="pre">loop</span></code> operation did not specify
<code class="docutils literal notranslate"><span class="pre">storeIterationsAsEntity</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">successes</span></code>: The number of successful operations that the workload
executor performed over the looped operations. If set, this value MUST be
assigned to the workload executor’s <code class="docutils literal notranslate"><span class="pre">numSuccesses</span></code> variable. Note that
this entity may be unset if the workload’s <code class="docutils literal notranslate"><span class="pre">loop</span></code> operation did not
specify <code class="docutils literal notranslate"><span class="pre">storeSuccessesAsEntity</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">errors</span></code>: Array of documents describing the errors that occurred
while the workload executor was executing the operations. If set, any
documents in this array MUST be appended to the workload executor’s
<code class="docutils literal notranslate"><span class="pre">errors</span></code> array. Note that this entity may be unset if the workload’s
<code class="docutils literal notranslate"><span class="pre">loop</span></code> operation did not specify <code class="docutils literal notranslate"><span class="pre">storeErrorsAsEntity</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">failures</span></code>: Array of documents describing the failures that occurred
while the workload executor was executing the operations. If set, any
documents in this array MUST be appended to the workload executor’s
<code class="docutils literal notranslate"><span class="pre">failures</span></code> array. Note that this entity may be unset if the workload’s
<code class="docutils literal notranslate"><span class="pre">loop</span></code> operation did not specify <code class="docutils literal notranslate"><span class="pre">storeFailuresAsEntity</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">events</span></code>: Array of documents describing the command and CMAP events
that occurred while the workload executor was executing the operations. If
set, and documents in this array MUST be appended to the workload
executor’s <code class="docutils literal notranslate"><span class="pre">events</span></code> array. Note that this entity may be unset if the
workload’s client entity did not specify <code class="docutils literal notranslate"><span class="pre">storeEventsAsEntities</span></code>.</p></li>
</ul>
</li>
<li><p>MUST write the <code class="docutils literal notranslate"><span class="pre">events</span></code>, <code class="docutils literal notranslate"><span class="pre">errors</span></code>, and <code class="docutils literal notranslate"><span class="pre">failures</span></code> variables to a JSON
file named <code class="docutils literal notranslate"><span class="pre">events.json</span></code> in the current working directory (i.e. directory
from where the workload executor is being executed). The data written MUST
be an object with the following fields:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">events</span></code>: Array of event objects (e.g. observed command or CMAP events).
Per the unified test format, each object is expected to have a <code class="docutils literal notranslate"><span class="pre">name</span></code>
string field and an <code class="docutils literal notranslate"><span class="pre">observedAt</span></code> numeric field, in addition to any other
fields specific to the event’s type.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">errors</span></code>: Array of error objects. Per the unified test format, each
object is expected to have an <code class="docutils literal notranslate"><span class="pre">error</span></code> string field and a <code class="docutils literal notranslate"><span class="pre">time</span></code> numeric
field.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">failures</span></code>: Array of failure objects. Per the unified test format, each
object is expected to have an <code class="docutils literal notranslate"><span class="pre">error</span></code> string field and a <code class="docutils literal notranslate"><span class="pre">time</span></code> numeric
field.</p></li>
</ul>
<p>Note that is possible for some or all of these arrays to be empty if the
corresponding data was not reported by the unified test runner and the test
runner did not propagate an error or failure (which would then be reported by
the workload executor).</p>
</li>
<li><p>MUST write the collected workload statistics into a JSON file named
<code class="docutils literal notranslate"><span class="pre">results.json</span></code> in the current working directory (i.e. the directory
from where the workload executor is being executed). Workload statistics
MUST contain the following fields (drivers MAY report additional statistics
using field names of their choice):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">numErrors</span></code>: The number of errors that were encountered during the test.
This includes errors handled by either the unified test runner or the
workload executor. The reported value MUST equal the size of the <code class="docutils literal notranslate"><span class="pre">errors</span></code>
array reported in <code class="docutils literal notranslate"><span class="pre">events.json</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numFailures</span></code>: The number of failures that were encountered during the
test. This includes failures handled by either the unified test runner or
the workload executor. The reported value MUST equal the size of the
<code class="docutils literal notranslate"><span class="pre">failures</span></code> array reported in <code class="docutils literal notranslate"><span class="pre">events.json</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numSuccesses</span></code>: The number of successful operations executed during the
test. This MAY be -1 if a <code class="docutils literal notranslate"><span class="pre">successes</span></code> entity was never reported by the
unified test runner.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numIterations</span></code>: The number of loop iterations executed during the test.
This MAY be -1 if an <code class="docutils literal notranslate"><span class="pre">iterations</span></code> entity was never reported by the
unified test runner.</p></li>
</ul>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The values of <code class="docutils literal notranslate"><span class="pre">numErrors</span></code> and <code class="docutils literal notranslate"><span class="pre">numFailures</span></code> are used by
<code class="docutils literal notranslate"><span class="pre">astrolabe</span></code> to determine the overall success or failure of a driver
workload execution. A non-zero value for either of these fields is construed
as a sign that something went wrong while executing the workload and the test
is marked as a failure. The workload executor’s exit code is <strong>not</strong> used for
determining success/failure and is ignored.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If <code class="docutils literal notranslate"><span class="pre">astrolabe</span></code> encounters an error attempting to parse the workload
statistics written to <code class="docutils literal notranslate"><span class="pre">results.json</span></code> (caused, for example, by malformed
JSON or a nonexistent file), the test will be assumed to have failed.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The choice of termination signal used by <code class="docutils literal notranslate"><span class="pre">astrolabe</span></code> varies by
platform. <code class="docutils literal notranslate"><span class="pre">SIGINT</span></code> <a class="footnote-reference brackets" href="#f1" id="id2">1</a> is used as the termination signal on Linux and
OSX, while <code class="docutils literal notranslate"><span class="pre">CTRL_BREAK_EVENT</span></code> <a class="footnote-reference brackets" href="#f2" id="id3">2</a> is used on Windows.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On Windows systems, the workload executor is invoked via Cygwin Bash.</p>
</div>
</section>
<section id="pseudocode-implementation">
<h2>Pseudocode Implementation<a class="headerlink" href="#pseudocode-implementation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span>/* The workloadRunner function accepts a connection string and a stringified
 * JSON blob describing the driver workload. This function will be invoked
 * with arguments parsed from the command-line invocation of the workload
 * executor script. */
function workloadRunner(connectionString: string, driverWorkload: object): void {

    # Use the driver&#39;s unified test runner to run the workload
    const runner = UnifiedTestRunner(connectionString);

    var events = []
    var errors = []
    var failures = []
    var numIterations = -1
    var numSuccesses = -1

    /* The workload executor MUST handle the termination signal gracefully
     * and instruct the unified test runner to stop looping. The termination
     * signal will be used by astrolabe to terminate tests that would
     * otherwise run ad infinitum.
    process.once(&#39;SIGINT&#39;, function (code) { ... });

    try {
        runner.executeScenario();
    } catch (propagatedError) {
        /* If the test runner propagates an error or failure (e.g. it is not
         * captured by the loop or occurs outside of the loop), it MUST be
         * reported by the workload executor. */
         errors.push({
           error: propagatedError.message,
           time: Date.now() / 1000
         });
    }

    if (runner.entityMap.has(&#39;events&#39;)) {
        events = events.concat(runner.entityMap.get(&#39;events&#39;);
    }

    if (runner.entityMap.has(&#39;errors&#39;)) {
        errors = errors.concat(runner.entityMap.get(&#39;errors&#39;);
    }

    if (runner.entityMap.has(&#39;failures&#39;)) {
        failures = failures.concat(runner.entityMap.get(&#39;failures&#39;);
    }

    if (runner.entityMap.has(&#39;iterations&#39;)) {
        numIterations = runner.entityMap.get(&#39;iterations&#39;);
    }

    if (runner.entityMap.has(&#39;successes&#39;)) {
        numSuccesses = runner.entityMap.get(&#39;successes&#39;);
    }

    numErrors = errors.length
    numFailures = failures.length

    /* The events.json and results.json files MUST be written to the current
     * working directory from which this script is executed, which is not
     * necessarily the same directory where the script itself resides. */
    fs.writeFile(&#39;events.json&#39;, JSON.stringify({
        events: events,
        errors: errors,
        failures: failures,
    }));

    fs.writeFile(&#39;results.json&#39;, JSON.stringify({
        numErrors: numErrors,
        numFailures: numFailures,
        numSuccesses: numSuccesses,
        numIterations: numIterations,
    }));
}
</pre></div>
</div>
</section>
<section id="reference-implementation">
<h2>Reference Implementation<a class="headerlink" href="#reference-implementation" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/mongodb-labs/drivers-atlas-testing/blob/master/integrations/ruby/workload-executor">Ruby’s workload executor</a>
serves as the reference implementation of the script described by this specification.</p>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="f1"><span class="brackets"><a class="fn-backref" href="#id2">1</a></span></dt>
<dd><p>See <a class="reference external" href="http://man7.org/linux/man-pages/man7/signal.7.html">http://man7.org/linux/man-pages/man7/signal.7.html</a> for details about Linux signals</p>
</dd>
<dt class="label" id="f2"><span class="brackets"><a class="fn-backref" href="#id3">2</a></span></dt>
<dd><p>See <a class="reference external" href="https://docs.microsoft.com/en-us/windows/console/ctrl-c-and-ctrl-break-signals">https://docs.microsoft.com/en-us/windows/console/ctrl-c-and-ctrl-break-signals</a> for details about Windows
console events</p>
</dd>
</dl>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">astrolabe</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installing-running-locally.html">Installing and Running Locally</a></li>
<li class="toctree-l1"><a class="reference internal" href="integration-guide.html">Integration Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Workload Executor Specification</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#user-facing-api">User-Facing API</a></li>
<li class="toctree-l2"><a class="reference internal" href="#behavioral-description">Behavioral Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pseudocode-implementation">Pseudocode Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="spec-test-format.html">Atlas Planned Maintenance Test Scenario Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="technical-design.html">Technical Design: Testing Drivers Against Atlas Planned Maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="integration-guide.html" title="previous chapter">Integration Guide</a></li>
      <li>Next: <a href="spec-test-format.html" title="next chapter">Atlas Planned Maintenance Test Scenario Format</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, MongoDB, Inc..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/spec-workload-executor.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>